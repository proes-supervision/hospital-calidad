<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGCO - Sistema de Gestión de Calidad en Obra</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo simple para el spinner */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-spin { display: inline-block; animation: spin 1s linear infinite; }
        
        /* MODIFICADO v12: Ocultar vistas, mostrar LOGIN por defecto */
        .view { display: none; }
        #view-login { display: block; }
        
        /* (Bug 3) Mejoras visuales en el formulario */
        fieldset {
            border-top: 1px solid #e5e7eb; /* Divisor */
            padding-top: 1.5rem; /* Espacio */
            margin-top: 1.5rem; /* Espacio */
        }
        fieldset:first-of-type {
            border-top: none; /* Sin borde en el primero */
            margin-top: 0;
            padding-top: 0;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans" id="app-body">

    <!-- Notificador de Estado Global -->
    <div id="upload-status" class="hidden fixed top-4 right-4 z-50 p-3 text-center text-sm text-white rounded-md shadow-lg transition-all duration-300"></div>

    <!-- VISTA 0: LOGIN (NUEVO v12) -->
    <div id="view-login" class="view min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-lg shadow-lg">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    SGCO
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Sistema de Gestión de Calidad en Obra
                </p>
            </div>
            <form id="form-login" class="mt-8 space-y-6">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="login-usuario" class="sr-only">Usuario</label>
                        <input id="login-usuario" name="usuario" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Usuario">
                    </div>
                    <div>
                        <label for="login-password" class="sr-only">Contraseña</label>
                        <input id="login-password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Contraseña">
                    </div>
                </div>

                <div>
                    <button type="submit" id="login-submit-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-blue-500 group-hover:text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        Ingresar
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Contenedor Principal (Oculto hasta el login) -->
    <div id="view-main-app" class="view container mx-auto p-4 md:p-8">
        <!-- Cabecera -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-blue-900">Sistema de Gestión de Calidad en Obra (SGCO)</h1>
                <p class="text-xl text-gray-600">Proyecto: Hospital de Segundo Nivel Isaías</p>
            </div>
            <!-- Info del Usuario Logueado (v12) -->
            <div class="text-right">
                <p class="text-sm text-gray-700">Usuario: <strong id="user-display-name">N/A</strong></p>
                <p class="text-sm text-gray-500">Rol: <strong id="user-display-rol">N/A</strong></p>
                <button onclick="window.appLogout()" class="text-xs text-red-500 hover:underline">Cerrar Sesión</button>
            </div>
        </header>

        <!-- Navegación de Pestañas (Vistas) -->
        <div class="border-b border-gray-300 mb-6">
            <nav class="flex -mb-px space-x-6">
                <button id="btn-tab-dashboard" onclick="showView('dashboard')" class="py-3 px-1 border-b-4 font-medium text-blue-600 border-blue-600 focus:outline-none">
                    Dashboard (RNC Abiertas)
                </button>
                <button id="btn-tab-inspeccion" onclick="showView('inspeccion')" class="py-3 px-1 border-b-4 font-medium text-gray-600 hover:text-blue-600 hover:border-blue-600 border-transparent focus:outline-none">
                    Registrar Inspección
                </button>
            </nav>
        </div>

        <!-- VISTA 1: DASHBOARD DE RNCs ABIERTAS -->
        <div id="view-dashboard" class="view-app" style="display: block;"> <!-- Se muestra por defecto post-login -->
            <section>
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Reporte de No Conformidades (RNCs) Abiertas</h2>
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Fecha</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Supervisor</th> <!-- (v12) Quién la creó -->
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Protocolo</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Área</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Defecto</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Responsable</th>
                                    <th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Evidencia</th>
                                    <th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Acción</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="rnc-table-body">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- VISTA 2: FORMULARIO DE NUEVA INSPECCIÓN -->
        <div id="view-inspeccion" class="view-app" style="display: none;"> <!-- Oculto por defecto -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                
                <!-- Paso 1: Seleccionar Protocolo -->
                <form id="form-step-1" class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800">Paso 1: Iniciar Inspección</h2>
                    <fieldset class="space-y-4" style="border-top: none; margin-top: 0; padding-top: 0;">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="insp-protocolo" class="block text-sm font-medium text-gray-700">Seleccione el Protocolo a Inspeccionar</label>
                                <select id="insp-protocolo" name="insp-protocolo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Cargando protocolos...</option>
                                </select>
                            </div>
                            <div>
                                <label for="insp-area" class="block text-sm font-medium text-gray-700">Área / Sector de Inspección</label>
                                <input type="text" id="insp-area" name="insp-area" placeholder="Ej: Bloque B, Piso 2, Eje 4-5" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        <!-- (v12) CAMPO DE SUPERVISOR ELIMINADO. Se toma del login. -->
                    </fieldset>
                    <div class="text-right">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:bg-blue-700">
                            Cargar Checklist
                        </button>
                    </div>
                </form>

                <!-- Paso 2: Ejecutar Checklist (Oculto) -->
                <form id="form-step-2" class="space-y-6 hidden">
                    <fieldset>
                        <legend class="text-xl font-semibold text-gray-800">Paso 2: Ejecutar Checklist para <span id="checklist-title" class="text-blue-700"></span></legend>
                        <div id="checklist-items-container" class="space-y-3 mt-4">
                            <!-- Items de checklist generados por JS -->
                        </div>
                    </fieldset>
                    
                    <!-- Paso 3: Formulario RNC (Oculto, solo aparece si algo es Rechazado) -->
                    <div id="rnc-form-container" class="hidden">
                        <fieldset class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                            <legend class="text-lg font-bold text-red-800">¡Inspección RECHAZADA!</legend>
                            <p class="text-red-700">Se requiere una No Conformidad (RNC) para los ítems rechazados.</p>
                            <div class="space-y-3 mt-4">
                                <div>
                                    <label for="rnc-defecto" class="block text-sm font-medium text-gray-700">Descripción del Defecto (Resumido)</label>
                                    <textarea id="rnc-defecto" name="rnc-defecto" rows="3" placeholder="Ej: Estribos en Viga V-102 con separación de 25cm en lugar de 15cm." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                </div>
                                <div>
                                    <label for="rnc-responsable" class="block text-sm font-medium text-gray-700">Responsable de la Corrección</label>
                                    <input type="text" id="rnc-responsable" name="rnc-responsable" placeholder="Ej: Contratista Z&Z" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="rnc-foto" class="block text-sm font-medium text-gray-700">Evidencia (Foto del Defecto)</label>
                                    <input type="file" id="rnc-foto" name="rnc-foto" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-red-100 file:text-red-700 hover:file:bg-red-200">
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Botones Finales -->
                    <div class="flex justify-end gap-3 pt-4 border-t">
                         <button type="button" id="cancel-checklist-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" id="submit-inspection-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:bg-green-700">
                            Finalizar Inspección (Aprobar)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pie de página -->
        <footer class="mt-12 pt-6 border-t border-gray-300 text-center text-sm text-gray-500">
            <p>
                Desarrollado por Zacarias Ortega para el Proyecto Construcción Hospital de Segundo Nivel Isaías - Oruro
            </p>
        </footer>
    </div>

    <!-- Script principal del aplicativo (v12 - Con Login) -->
    <script>
        // -----------------------------------------------------------------
        // SCRIPT v12: LÓGICA DEL APLICATIVO DE CALIDAD
        // -----------------------------------------------------------------

        // ¡¡¡IMPORTANTE!!! Usted deberá pegar aquí la URL de su API de Google Apps Script
        const G_APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwf8905psxBJVEIoBDR_S9okVC16u3bEGhuzHrrk1GEdvfW0OILtzOfGzeVbTgIoa_7-w/exec";

        // (v12) Variable global para guardar los datos del usuario logueado
        let loggedInUser = null; 
        
        let currentProtocolos = [];
        let currentChecklist = [];
        let currentInspectionData = {};

        // --- Funciones de Utilidad ---
        function showNotification(message, type = 'info') {
            const statusEl = document.getElementById('upload-status');
            if (!statusEl) return;
            statusEl.classList.remove('hidden', 'bg-blue-500', 'bg-red-500', 'bg-green-500');
            if (type === 'error') statusEl.classList.add('bg-red-500');
            else if (type === 'success') statusEl.classList.add('bg-green-500');
            else statusEl.classList.add('bg-blue-500');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 4000);
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        // (v11) Romper la caché de Google Apps Script
        function getCacheBustUrl(url) {
            const cacheBust = new Date().getTime();
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}cacheBust=${cacheBust}`;
        }

        // --- Control de Vistas (v12 - Modificado para Login) ---
        function showView(viewName) {
            // Ocultar todas las vistas principales
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');

            if (viewName === 'login') {
                document.getElementById('view-login').style.display = 'block';
            } else {
                // Si es cualquier otra vista, mostrar el contenedor principal
                document.getElementById('view-main-app').style.display = 'block';
                
                // Y luego manejar las pestañas internas
                document.querySelectorAll('.view-app').forEach(v => v.style.display = 'none');
                document.getElementById(`view-${viewName}`).style.display = 'block';
                
                document.querySelectorAll('nav button').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-blue-600');
                    b.classList.add('text-gray-600', 'border-transparent');
                });
                document.getElementById(`btn-tab-${viewName}`).classList.add('text-blue-600', 'border-blue-600');

                if (viewName === 'dashboard') loadRNCs();
                if (viewName === 'inspeccion') resetFormStep1();
            }
        }
        
        function resetFormStep1() {
            document.getElementById('form-step-1').classList.remove('hidden');
            document.getElementById('form-step-2').classList.add('hidden');
            document.getElementById('rnc-form-container').classList.add('hidden');
            document.getElementById('form-step-1').reset();
            currentChecklist = [];
            currentInspectionData = {};
        }

        // --- Lógica de Login (NUEVO v12) ---
        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin mr-2">&#9696;</span> Ingresando...';
            
            try {
                if (G_APP_SCRIPT_URL === "PEGUE_SU_URL_DE_APPS_SCRIPT_AQUI") {
                    if (window.location.protocol === 'blob:') {
                        // Simulación para Vista Previa
                        loggedInUser = { nombre_completo: "Usuario de Prueba", rol: "Admin" };
                        showNotification("Modo simulación: Ingreso exitoso.", "success");
                    } else {
                        throw new Error("API URL no está configurada.");
                    }
                } else {
                    const payload = {
                        action: "checkLogin",
                        usuario: form.usuario.value,
                        contrasena: form.password.value
                    };
                    
                    const response = await fetch(G_APP_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    if (response.status !== 200 || result.status !== 'success') {
                        throw new Error(result.message || 'Error en el servidor');
                    }
                    
                    // ¡ÉXITO! Guardamos al usuario
                    loggedInUser = result.user;
                }

                document.getElementById('user-display-name').textContent = loggedInUser.nombre_completo;
                document.getElementById('user-display-rol').textContent = loggedInUser.rol;
                
                // Cargamos la app principal
                showView('dashboard'); // Mostrar el dashboard
                loadProtocolos(); // Cargar los protocolos en segundo plano
                
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                showNotification("Error: " + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'Ingresar';
            }
        }
        
        function appLogout() {
            loggedInUser = null;
            document.getElementById('form-login').reset();
            showView('login');
            showNotification("Sesión cerrada con éxito.", 'success');
        }
        window.appLogout = appLogout; // Exponer al global


        // --- Lógica de Carga de Datos (GET) ---

        async function loadProtocolos() {
            try {
                if (G_APP_SCRIPT_URL === "PEGUE_SU_URL_DE_APPS_SCRIPT_AQUI") { return; } // No cargar si no hay API

                const url = getCacheBustUrl(`${G_APP_SCRIPT_URL}?action=getProtocolos`);
                const response = await fetch(url);
                const data = await response.json();
                if (data.status !== 'success') throw new Error(data.message);
                
                currentProtocolos = data.protocolos;
                const select = document.getElementById('insp-protocolo');
                select.innerHTML = '<option value="">Seleccione un protocolo...</option>';
                
                if(currentProtocolos.length > 0 && !currentProtocolos[0].protocolo_id) {
                    console.warn("Datos de protocolo recibidos, pero faltan cabeceras 'protocolo_id' o 'nombre_protocolo' en el Google Sheet 'Biblioteca_Protocolos'.");
                    showNotification("Error: Revise las cabeceras en su Google Sheet 'Biblioteca_Protocolos'.", 'error');
                    return;
                }

                currentProtocolos.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.protocolo_id;
                    option.textContent = p.nombre_protocolo;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar protocolos:", error);
                showNotification("Error al cargar protocolos: " + error.message, 'error');
            }
        }

        async function loadRNCs() {
            const tableBody = document.getElementById('rnc-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center">Cargando RNCs abiertas...</td></tr>';
            try {
                if (G_APP_SCRIPT_URL === "PEGUE_SU_URL_DE_APPS_SCRIPT_AQUI") {
                    if (window.location.protocol === 'blob:') {
                         tableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">Modo simulación. Conecte API.</td></tr>';
                         return;
                    }
                    throw new Error("API URL no configurada.");
                }

                const url = getCacheBustUrl(`${G_APP_SCRIPT_URL}?action=getRNCs`);
                const response = await fetch(url);
                const data = await response.json();
                if (data.status !== 'success') throw new Error(data.message);
                
                tableBody.innerHTML = '';
                if (data.rncs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">¡Felicidades! No hay No Conformidades abiertas.</td></tr>';
                }
                
                data.rncs.forEach(rnc => {
                    const row = document.createElement('tr');
                    const fotoHtml = rnc.foto_url ? `<a href="${rnc.foto_url}" target="_blank" class="text-blue-600 hover:underline">Ver Foto</a>` : 'No/Disp';
                                        
                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-700">${rnc.fecha_hora}</td>
                        <td class="p-3 text-sm text-gray-700">${rnc.supervisor}</td> <!-- (v12) Quién la creó -->
                        <td class="p-3 text-sm text-gray-700">${rnc.protocolo_id}</td>
                        <td class="p-3 text-sm text-gray-700">${rnc.area}</td>
                        <td class="p-3 text-sm text-red-700">${rnc.defecto}</td>
                        <td class="p-3 text-sm text-gray-700">${rnc.responsable}</td>
                        <td class="p-3 text-sm text-center">${fotoHtml}</td>
                        <td class="p-3 text-sm text-center">
                            <!-- (v12) Bug corregido: Pasa el row_index -->
                            <button onclick="window.closeRNC(this, ${rnc.row_index})" class="bg-green-600 text-white text-xs font-bold py-1 px-2 rounded hover:bg-green-700">
                                Cerrar RNC
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error al cargar RNCs:", error);
                showNotification("Error al cargar RNCs: " + error.message, 'error');
            }
        }

        // --- Lógica de Formularios (POST) ---

        // Paso 1: Cargar el checklist
        async function handleLoadChecklist(e) {
            e.preventDefault();
            const protocoloId = document.getElementById('insp-protocolo').value;
            const area = document.getElementById('insp-area').value;
            
            if (!protocoloId || !area) {
                showNotification("Por favor, complete Protocolo y Área.", 'error');
                return;
            }

            // (v12) El supervisor se toma del login
            currentInspectionData = { protocoloId, area, supervisor: loggedInUser.nombre_completo };
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin mr-2">&#9696;</span> Cargando...';
            
            try {
                const url = getCacheBustUrl(`${G_APP_SCRIPT_URL}?action=getChecklist&protocoloId=${protocoloId}`);
                const response = await fetch(url);
                const data = await response.json();
                if (data.status !== 'success') throw new Error(data.message);
                
                currentChecklist = data.checklist;
                const container = document.getElementById('checklist-items-container');
                container.innerHTML = '';
                
                if (currentChecklist.length === 0) {
                    container.innerHTML = '<p class="text-red-500">Error: No se encontraron ítems de checklist para este protocolo en la base de datos (Hoja: Biblioteca_Checklists).</p>';
                    btn.disabled = false;
                    btn.innerHTML = 'Cargar Checklist';
                    return;
                }
                
                currentChecklist.forEach((item, index) => {
                    const itemHtml = `
                        <div class="p-3 border rounded-md bg-gray-50">
                            <label class="block text-sm font-medium text-gray-800">${item.item_descripcion}</label>
                            <p class="text-xs text-gray-500 mb-2">Especificación: ${item.especificacion || 'N/A'}</p>
                            <div class="flex space-x-4">
                                <label class="flex items-center"><input type="radio" name="item-${index}" value="Aprobado" class="mr-1" required onchange="window.checkIfRejected()"> Aprobado</label>
                                <label class="flex items-center"><input type="radio" name="item-${index}" value="Rechazado" class="mr-1" onchange="window.checkIfRejected()"> Rechazado</label>
                                <label class="flex items-center"><input type="radio" name="item-${index}" value="N/A" class="mr-1" onchange="window.checkIfRejected()"> N/A</label>
                            </div>
                        </div>
                    `;
                    container.innerHTML += itemHtml;
                });

                document.getElementById('form-step-1').classList.add('hidden');
                document.getElementById('form-step-2').classList.remove('hidden');
                document.getElementById('checklist-title').textContent = protocoloId;

            } catch (error) {
                console.error("Error al cargar checklist:", error);
                showNotification("Error al cargar checklist: " + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Cargar Checklist';
            }
        }
        
        // Se llama cada vez que se marca un radio button
        window.checkIfRejected = () => {
            const form = document.getElementById('form-step-2');
            const formData = new FormData(form);
            let isRejected = false;
            for (const [key, value] of formData.entries()) {
                if (value === 'Rechazado') {
                    isRejected = true;
                    break;
                }
            }
            
            const rncContainer = document.getElementById('rnc-form-container');
            const submitBtn = document.getElementById('submit-inspection-btn');
            
            if (isRejected) {
                rncContainer.classList.remove('hidden');
                submitBtn.textContent = 'Finalizar Inspección (Generar RNC)';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                rncContainer.classList.add('hidden');
                submitBtn.textContent = 'Finalizar Inspección (Aprobar)';
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            }
        }
        window.checkIfRejected = window.checkIfRejected; // Exponerlo globalmente

        // Paso 2: Guardar la inspección
        async function handleSaveInspection(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            
            // 1. Recolectar resultados del checklist
            const form = document.getElementById('form-step-2');
            const formData = new FormData(form);
            let isRejected = false;
            let itemsResult = [];
            let allAnswered = true;
            
            for (let i = 0; i < currentChecklist.length; i++) {
                const resultado = formData.get(`item-${i}`);
                if (!resultado) {
                    allAnswered = false;
                    break;
                }
                if (resultado === 'Rechazado') isRejected = true;
                itemsResult.push({ item: currentChecklist[i].item_descripcion, resultado: resultado });
            }

            if (!allAnswered) {
                 showNotification("Por favor, responda todos los ítems del checklist.", 'error');
                 return;
            }
            
            const payload = {
                action: "saveInspeccion",
                protocoloId: currentInspectionData.protocoloId,
                area: currentInspectionData.area,
                supervisor: loggedInUser.nombre_completo, // (v12) Supervisor logueado
                resultado: isRejected ? "Rechazado" : "Aprobado",
                items: itemsResult,
                rnc: {}
            };

            // 2. Si es Rechazado, recolectar datos de RNC
            if (isRejected) {
                const rncDefecto = document.getElementById('rnc-defecto').value;
                const rncResponsable = document.getElementById('rnc-responsable').value;
                const rncFotoInput = document.getElementById('rnc-foto');
                
                if (!rncDefecto || !rncResponsable) {
                    showNotification("Si la inspección es Rechazada, debe llenar la descripción del defecto y el responsable.", 'error');
                    return; // Detener el guardado
                }
                
                payload.rnc.defecto = rncDefecto;
                payload.rnc.responsable = rncResponsable;
                
                if (rncFotoInput.files[0]) {
                    showNotification("Procesando foto de evidencia...", 'info');
                    payload.rnc.fileData = await fileToBase64(rncFotoInput.files[0]);
                    payload.rnc.fileName = rncFotoInput.files[0].name;
                    payload.rnc.fileType = rncFotoInput.files[0].type;
                }
            }

            // 3. Enviar todo al "Mesero" (Apps Script)
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin mr-2">&#9696;</span> Guardando...';

            try {
                if (G_APP_SCRIPT_URL === "PEGUE_SU_URL_DE_APPS_SCRIPT_AQUI") {
                    throw new Error("API URL no configurada.");
                }

                const response = await fetch(G_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    // (v12) El login no necesita contraseña, ya está logueado
                    body: JSON.stringify(payload) 
                });
                
                const result = await response.json();
                if (response.status !== 200 || result.status !== 'success') {
                    throw new Error(result.message || 'Error en el servidor de Apps Script');
                }

                showNotification(isRejected ? "RNC generada con éxito." : "Inspección Aprobada con éxito.", 'success');
                showView('dashboard'); // Volver al dashboard
                
            } catch (error) {
                console.error("Error al guardar inspección:", error);
                showNotification("Error al guardar: " + error.message, 'error');
            } finally {
                btn.disabled = false;
                checkIfRejected(); // Resetea el texto y color del botón
            }
        }

        // (v12) Bug Corregido: Ahora usa rowIndex
        async function closeRNC(buttonEl, rowIndex) {
            if (!confirm(`¿Está seguro de que desea CERRAR esta No Conformidad?`)) {
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = 'Cerrando...';
            
            try {
                if (G_APP_SCRIPT_URL === "PEGUE_SU_URL_DE_APPS_SCRIPT_AQUI") {
                    throw new Error("API URL no configurada.");
                }

                const payload = {
                    action: "closeRNC",
                    rowIndex: rowIndex, // <-- (v12) ID Confiable
                    supervisorCierre: loggedInUser.nombre_completo // (v12) Quién lo cerró
                };
                
                const response = await fetch(G_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (response.status !== 200 || result.status !== 'success') {
                    throw new Error(result.message || 'Error en el servidor de Apps Script');
                }
                
                showNotification("RNC cerrada con éxito.", 'success');
                loadRNCs(); // Recargar la tabla del dashboard
                
            } catch (error) {
                console.error("Error al cerrar RNC:", error);
                showNotification("Error al cerrar RNC: " + error.message, 'error');
                buttonEl.disabled = false;
                buttonEl.textContent = 'Cerrar RNC';
            }
        }
        // Exponer la función al scope global
        window.closeRNC = closeRNC;
        window.showView = showView;


        // --- Event Listeners Globales ---
        document.addEventListener('DOMContentLoaded', () => {
            // (v12) Configuración inicial
            if (G_APP_SCRIPT_URL === "PEGUE_SU_URL_DE_APPS_SCRIPT_AQUI") {
                 if (window.location.protocol !== 'blob:') {
                    showNotification("Error: El aplicativo no está conectado. Configure la URL de la API.", 'error');
                 }
            }
            
            // Listeners de Formularios
            document.getElementById('form-login').addEventListener('submit', handleLogin);
            document.getElementById('form-step-1').addEventListener('submit', handleLoadChecklist);
            document.getElementById('form-step-2').addEventListener('submit', handleSaveInspection);
            document.getElementById('cancel-checklist-btn').addEventListener('click', () => showView('inspeccion'));
        });

    </script>
</body>
</html>
